<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${title.title}">Book Details</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            width: 100%;
            padding: 20px 40px;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        header h1 {
            margin: 0;
            font-size: 22px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            font-weight: bold;
            border: 1px solid white;
            padding: 6px 12px;
            border-radius: 5px;
        }
        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .logout-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            background: #e74c3c;
            color: white;
        }
        .logout-btn:hover {
            background: #c0392b;
        }

        main {
            flex: 1;
            width: 100%;
            max-width: 900px;
            margin-top: 30px;
        }

        h2 {
            margin-top: 0;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            padding: 20px 24px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 30px;
        }

        .details-grid div span.label {
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
            font-size: 14px;
        }

        th {
            background: #ecf0f1;
            font-weight: 600;
        }

        tbody tr:hover {
            background: #f8f9f9;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary[disabled] {
            opacity: 0.5;
            cursor: default;
        }

        .status-available {
            color: #27ae60;
            font-weight: 600;
        }
        .status-unavailable {
            color: #e67e22;
            font-weight: 600;
        }

        .message {
            margin-top: 10px;
            font-size: 13px;
        }
        .message.error {
            color: #e74c3c;
        }
        .message.success {
            color: #27ae60;
        }
        .message.info {
            color: #7f8c8d;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }
        
        .close:hover,
        .close:focus {
            color: #000;
        }
        
        .modal-content h2 {
            margin-top: 0;
            color: #333;
        }
        
        .modal-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .modal-content label input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .modal-content input[type="checkbox"] {
            width: auto;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

<header>
    <h1 th:text="${title.title}">Book Title</h1>
    <div class="header-right">
        <a href="/titles" class="back-btn">‚Üê Back to Catalog</a>
        <button class="logout-btn" id="logoutButton">Logout</button>
    </div>
</header>

<main>
    <!-- Book details -->
    <div class="card">
        <h2>Book Details</h2>
        <div class="details-grid">
            <div>
                <span class="label">Author: </span>
                <span th:text="${title.author}">Author Name</span>
            </div>
            <div>
                <span class="label">ISBN: </span>
                <span th:text="${title.ISBN}">1234567890</span>
            </div>
            <div>
                <span class="label">Year Published: </span>
                <span th:text="${title.yearPublished}">2000</span>
            </div>
            <div>
                <span class="label">Genre: </span>
                <span th:text="${title.genre}">GENRE</span>
            </div>
        </div>

        <div style="margin-top:15px;">
            <span class="label">Availability: </span>
            <span th:if="${availability != null}">
                <span th:text="${availability.availableCopies}">0</span> /
                <span th:text="${availability.totalCopies}">0</span> copies available
            </span>
            <span th:if="${availability == null}">
                No availability information.
            </span>
        </div>
    </div>

    <!-- Copies list -->
    <div class="card">
        <h2>Copies</h2>
        <table>
            <thead>
            <tr>
                <th>Copy ID</th>
                <th>Barcode</th>
                <th>Location</th>
                <th>Status</th>
                <th th:if="${isStaff}">Visible</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody id="copiesTableBody">
            <!-- Filled by JS -->
            </tbody>
        </table>

        <!-- Global Place Hold button (members only) -->
        <div th:if="${!isStaff}" style="margin-top: 10px;">
            <button id="holdButton" class="btn-primary">
                Place Hold
            </button>
        </div>

        <div id="copiesMessage" class="message"></div>
    </div>

    <!-- Staff-only: holds for this title -->
    <div class="card" th:if="${isStaff}">
        <h2>Holds for This Title (Staff Only)</h2>
        <p id="holdsMessage" class="message info">Loading holds...</p>
        <table>
            <thead>
            <tr>
                <th>Hold ID</th>
                <th>User ID</th>
                <th>Status</th>
                <th>Position</th>
                <th>Placed At</th>
                <th>Ready At</th>
                <th>Pickup Expire</th>
            </tr>
            </thead>
            <tbody id="holdsTableBody">
            <!-- Filled by JS for staff -->
            </tbody>
        </table>
    </div>
</main>

<!-- Edit Copy Modal (Staff Only) -->
<div id="editCopyModal" class="modal" th:if="${isStaff}">
    <div class="modal-content">
        <span class="close" id="closeEditModal">&times;</span>
        <h2>Edit Copy</h2>
        <form id="editCopyForm">
            <input type="hidden" id="editCopyId" />
            <input type="hidden" id="editTitleId" />
            
            <label for="editBarcode">Barcode:</label>
            <input type="text" id="editBarcode" required />
            
            <label for="editLocation">Location:</label>
            <input type="text" id="editLocation" required />
            
            <label for="editStatus">Status:</label>
            <select id="editStatus" required>
                <option value="AVAILABLE">AVAILABLE</option>
                <option value="CHECKED_OUT">CHECKED_OUT</option>
                <option value="RESERVED">RESERVED</option>
                <option value="LOST">LOST</option>
                <option value="DAMAGED">DAMAGED</option>
                <option value="MAINTENANCE">MAINTENANCE</option>
            </select>
            
            <label for="editVisible">
                <input type="checkbox" id="editVisible" />
                Visible to Members
            </label>
            
            <p id="editCopyMessage" class="message"></p>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="submit" class="btn-primary">Save Changes</button>
                <button type="button" class="btn-secondary" id="cancelEditBtn">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    // Values from server
    const titleId = /*[[${title.titleID}]]*/ 0;
    const isStaff = /*[[${isStaff}]]*/ false;
    const availableCopiesServer = /*[[${availability != null ? availability.availableCopies : 0}]]*/ 0;
    const totalCopies = Number(/*[[${availability != null ? availability.totalCopies : 0}]]*/ 0);

    document.getElementById("logoutButton").addEventListener("click", async () => {
        try {
            await fetch("/api/auth/logout", { method: "POST" });
        } catch (e) {}
        window.location.href = "/";
    });

    async function loadCopies() {
        const tbody  = document.getElementById("copiesTableBody");
        const msgBox = document.getElementById("copiesMessage");
        tbody.innerHTML = "";
        msgBox.textContent = "";
        msgBox.className = "message";

        const url = `/api/copies/title/${titleId}`;
        console.log("Loading copies from:", url);

        try {
            const res = await fetch(url, {
                headers: { "Accept": "application/json" }
            });

            if (!res.ok) {
                msgBox.textContent = `Failed to load copies (status ${res.status}).`;
                msgBox.classList.add("error");
                console.error("Copies request failed:", res.status, res.statusText);
                return;
            }

            let copies;
            try {
                copies = await res.json();
            } catch (jsonErr) {
                console.error("JSON parse error for copies:", jsonErr);
                msgBox.textContent = "Failed to parse copies data.";
                msgBox.classList.add("error");
                return;
            }

            if (!Array.isArray(copies) || copies.length === 0) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="6" class="message">No copies found for this title.</td>`;
                tbody.appendChild(tr);

                const holdBtn = document.getElementById("holdButton");
                if (holdBtn) {
                    holdBtn.disabled = true;
                    holdBtn.title = "There are no copies in the system for this title.";
                }
                return;
            }

            let anyAvailable = false;

            copies.forEach(c => {
                const tr = document.createElement("tr");

                const status   = c.status || c.copyStatus || "";
                const visible  = (c.visible === undefined || c.visible === null) ? "" : c.visible;
                const barcode  = c.barcode || "";
                const location = c.location || "";

                const isAvailable  = (status === "AVAILABLE");
                const isCheckedOut = (status === "CHECKED_OUT");

                if (isAvailable) {
                    anyAvailable = true;
                }

                // Decide what action button to show
                let actionHtml = "";
                if (!isStaff) {
                    // Member view: checkout buttons
                    if (isAvailable) {
                        actionHtml = `
                            <button class="btn-primary btn-action"
                                    data-action="checkout"
                                    data-barcode="${barcode}">
                                Check Out
                            </button>`;
                    } else if (isCheckedOut) {
                        actionHtml = `
                            <button class="btn-primary" disabled>
                                Checked Out
                            </button>`;
                    } else {
                        actionHtml = `
                            <button class="btn-primary" disabled>
                                Unavailable
                            </button>`;
                    }
                } else {
                    // Staff view: edit and delete buttons
                    const canDelete = (status !== "CHECKED_OUT" && status !== "LOST" && status !== "RESERVED");
                    actionHtml = `
                        <button class="btn-primary btn-action" 
                                data-action="edit"
                                data-copy-id="${c.copyID}"
                                data-title-id="${c.titleID}"
                                data-barcode="${barcode}"
                                data-location="${location}"
                                data-status="${status}"
                                data-visible="${visible}"
                                style="margin-right: 5px;">
                            Edit
                        </button>
                        <button class="btn-action" 
                                data-action="delete"
                                data-copy-id="${c.copyID}"
                                data-status="${status}"
                                style="background-color: #dc3545; color: white;"
                                ${!canDelete ? 'disabled' : ''}>
                            Delete
                        </button>
                    `;
                }

                tr.innerHTML = `
                    <td>${c.copyID}</td>
                    <td>${barcode}</td>
                    <td>${location}</td>
                    <td>
                        <span class="${isAvailable ? "status-available" : "status-unavailable"}">
                            ${status || (isAvailable ? "AVAILABLE" : "UNAVAILABLE")}
                        </span>
                    </td>
                    ${isStaff ? `<td>${visible}</td>` : ``}
                    <td>${actionHtml}</td>
                `;
                tbody.appendChild(tr);
            });

            // Enable/disable global hold button based on availability
            const holdBtn = document.getElementById("holdButton");
            if (holdBtn) {
                if (totalCopies === 0) {
                    holdBtn.disabled = true;
                    holdBtn.title = "There are no copies in the system for this title.";
                } else if (anyAvailable) {
                    holdBtn.disabled = true;
                    holdBtn.title = "Holds can only be placed when all copies are checked out.";
                } else {
                    holdBtn.disabled = false;
                    holdBtn.title = "";
                }
            }

        } catch (err) {
            console.error("Unexpected error in loadCopies:", err);
            msgBox.textContent = "Unexpected error while loading copies.";
            msgBox.classList.add("error");
        }
    }

    // Staff-only: load holds for this title
    async function loadTitleHolds() {
        const tbody = document.getElementById("holdsTableBody");
        const msgBox = document.getElementById("holdsMessage");
        if (!tbody || !msgBox) {
            return; // Not a staff view
        }

        msgBox.textContent = "Loading holds...";
        msgBox.className = "message info";
        tbody.innerHTML = "";

        try {
            const res = await fetch(`/api/holds/title/${titleId}`, {
                headers: { "Accept": "application/json" }
            });

            if (!res.ok) {
                msgBox.textContent = `Failed to load holds (status ${res.status}).`;
                msgBox.classList.add("error");
                console.error("Holds request failed:", res.status, res.statusText);
                return;
            }

            const holds = await res.json();

            // Filter to "current" holds: QUEUED or READY
            const activeHolds = Array.isArray(holds)
                ? holds.filter(h => h.status === "QUEUED" || h.status === "READY")
                : [];

            if (activeHolds.length === 0) {
                msgBox.textContent = "No current holds for this title.";
                msgBox.classList.remove("error");
                msgBox.classList.add("info");
                return;
            }

            msgBox.textContent = "";
            tbody.innerHTML = "";

            activeHolds.forEach(h => {
                const tr = document.createElement("tr");

                const holdId   = h.holdID;
                const userId   = h.userID;
                const status   = h.status;
                const position = h.position;
                const placedAt = h.placedAt || "";
                const readyAt  = h.readyAt || "";
                const expire   = h.pickupExpire || "";

                tr.innerHTML = `
                    <td>${holdId}</td>
                    <td>${userId}</td>
                    <td>${status}</td>
                    <td>${position}</td>
                    <td>${placedAt}</td>
                    <td>${readyAt}</td>
                    <td>${expire}</td>
                `;

                tbody.appendChild(tr);
            });

        } catch (err) {
            console.error("Unexpected error while loading holds:", err);
            msgBox.textContent = "Unexpected error while loading holds.";
            msgBox.classList.add("error");
        }
    }

    // Handle actions from the copies table
    document.getElementById("copiesTableBody").addEventListener("click", async (e) => {
        const btn = e.target.closest(".btn-action");
        if (!btn) return;

        const action = btn.dataset.action;
        const msgBox = document.getElementById("copiesMessage");
        msgBox.textContent = "";
        msgBox.className = "message";

        try {
            if (action === "checkout") {
                const barcode = btn.getAttribute("data-barcode");
                if (!barcode) return;

                const res = await fetch(`/api/loans/checkout?barcode=${encodeURIComponent(barcode)}`, {
                    method: "POST"
                });

                if (!res.ok) {
                    msgBox.textContent = "Failed to check out copy (only members can checkout, copy may not be available, or you have reached the maximum loan amount).";
                    msgBox.classList.add("error");
                    console.error("Checkout failed:", res.status, res.statusText);
                    return;
                }

                msgBox.textContent = "Copy checked out successfully!";
                msgBox.classList.add("success");

                // Refresh copies (and holds, for staff)
                await loadCopies();
                if (isStaff) {
                    await loadTitleHolds();
                }
            } else if (action === "edit") {
                // Open edit modal with current copy data
                const copyId = btn.dataset.copyId;
                const titleId = btn.dataset.titleId;
                const barcode = btn.dataset.barcode;
                const location = btn.dataset.location;
                const status = btn.dataset.status;
                const visible = btn.dataset.visible;
                
                document.getElementById("editCopyId").value = copyId;
                document.getElementById("editTitleId").value = titleId;
                document.getElementById("editBarcode").value = barcode;
                document.getElementById("editLocation").value = location;
                document.getElementById("editStatus").value = status;
                document.getElementById("editVisible").checked = (visible === true || visible === "true");
                document.getElementById("editCopyMessage").textContent = "";
                document.getElementById("editCopyMessage").className = "message";
                
                document.getElementById("editCopyModal").style.display = "block";
            } else if (action === "delete") {
                const copyId = btn.dataset.copyId;
                const status = btn.dataset.status;
                
                if (status === "CHECKED_OUT" || status === "LOST" || status === "RESERVED") {
                    msgBox.textContent = "Cannot delete copy with status: " + status;
                    msgBox.classList.add("error");
                    return;
                }
                
                if (!confirm(`Are you sure you want to delete copy ${copyId}?`)) {
                    return;
                }
                
                const res = await fetch(`/api/copies/${copyId}`, {
                    method: "DELETE"
                });
                
                if (!res.ok) {
                    let errorMsg = "Failed to delete copy. ";
                    try {
                        const errorText = await res.text();
                        if (errorText) {
                            errorMsg += errorText;
                        } else {
                            errorMsg += "It may have an active loan or invalid status.";
                        }
                    } catch (e) {
                        errorMsg += "It may have an active loan or invalid status.";
                    }
                    msgBox.textContent = errorMsg;
                    msgBox.classList.add("error");
                    console.error("Delete failed:", res.status, res.statusText);
                    return;
                }
                
                msgBox.textContent = "Copy deleted successfully!";
                msgBox.classList.add("success");
                
                await loadCopies();
                if (isStaff) {
                    await loadTitleHolds();
                }
            }
        } catch (err) {
            console.error("Error during action:", err);
            msgBox.textContent = "Network error while performing action.";
            msgBox.classList.add("error");
        }
    });

    // Global hold button logic (members only)
    const holdBtn = document.getElementById("holdButton");
    if (holdBtn) {
        holdBtn.addEventListener("click", async () => {
            const msgBox = document.getElementById("copiesMessage");
            msgBox.textContent = "";
            msgBox.className = "message";

            try {
                // 1) Check if user can place a hold (session-based)
                const canRes = await fetch(`/api/holds/canPlace?titleID=${titleId}`, {
                    method: "GET"
                });

                if (!canRes.ok) {
                    msgBox.textContent = "Failed to check if you can place a hold.";
                    msgBox.classList.add("error");
                    console.error("canPlaceHold failed:", canRes.status, canRes.statusText);
                    return;
                }

                const canPlace = await canRes.json();

                if (!canPlace) {
                    msgBox.textContent = "You cannot place a hold on this title (maybe you already have one or there are available copies).";
                    msgBox.classList.add("error");
                    return;
                }

                // 2) Actually place the hold
                const res1 = await fetch(`/api/holds/${titleId}`, {
                    method: "POST"
                });

                if (!res1.ok) {
                    msgBox.textContent = "Failed to place hold (only members can place holds, or you may already have a hold).";
                    msgBox.classList.add("error");
                    console.error("Hold failed:", res1.status, res1.statusText);
                    return;
                }

                msgBox.textContent = "Hold placed successfully!";
                msgBox.classList.add("success");

                // Refresh copies; for staff, also refresh holds
                await loadCopies();
                if (isStaff) {
                    await loadTitleHolds();
                }

            } catch (err) {
                console.error("Error placing hold:", err);
                msgBox.textContent = "Network error while placing hold.";
                msgBox.classList.add("error");
            }
        });
    }

    // Staff only: Edit copy modal handling
    if (isStaff) {
        const editModal = document.getElementById("editCopyModal");
        const closeEditModal = document.getElementById("closeEditModal");
        const cancelEditBtn = document.getElementById("cancelEditBtn");
        const editCopyForm = document.getElementById("editCopyForm");
        
        closeEditModal.onclick = () => {
            editModal.style.display = "none";
        };
        
        cancelEditBtn.onclick = () => {
            editModal.style.display = "none";
        };
        
        window.onclick = (event) => {
            if (event.target === editModal) {
                editModal.style.display = "none";
            }
        };
        
        editCopyForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const copyId = document.getElementById("editCopyId").value;
            const titleIdVal = document.getElementById("editTitleId").value;
            const barcode = document.getElementById("editBarcode").value.trim();
            const location = document.getElementById("editLocation").value.trim();
            const status = document.getElementById("editStatus").value;
            const visibleVal = document.getElementById("editVisible").checked;
            const editMsgBox = document.getElementById("editCopyMessage");
            
            editMsgBox.textContent = "";
            editMsgBox.className = "message";
            
            if (!barcode || !location) {
                editMsgBox.textContent = "Barcode and Location are required.";
                editMsgBox.classList.add("error");
                return;
            }
            
            try {
                const res = await fetch(`/api/copies/${copyId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        copyID: parseInt(copyId),
                        titleID: parseInt(titleIdVal),
                        barcode: barcode,
                        location: location,
                        status: status,
                        visible: visibleVal
                    })
                });
                
                if (!res.ok) {
                    let errorMsg = "Failed to update copy. ";
                    try {
                        const errorText = await res.text();
                        if (errorText) {
                            errorMsg += errorText;
                        } else {
                            errorMsg += "Please check the values and try again.";
                        }
                    } catch (e) {
                        errorMsg += "Please check the values and try again.";
                    }
                    editMsgBox.textContent = errorMsg;
                    editMsgBox.classList.add("error");
                    console.error("Update failed:", res.status, res.statusText);
                    return;
                }
                
                editMsgBox.textContent = "Copy updated successfully!";
                editMsgBox.classList.add("success");
                
                // Close modal after short delay
                setTimeout(() => {
                    editModal.style.display = "none";
                    const mainMsgBox = document.getElementById("copiesMessage");
                    mainMsgBox.textContent = "Copy updated successfully!";
                    mainMsgBox.className = "message success";
                }, 1000);
                
                // Refresh copies list
                await loadCopies();
                await loadTitleHolds();
                
            } catch (err) {
                console.error("Error updating copy:", err);
                editMsgBox.textContent = "Network error while updating copy.";
                editMsgBox.classList.add("error");
            }
        });
    }

    // Initial load
    (async () => {
        await loadCopies();
        if (isStaff) {
            await loadTitleHolds();
        }
    })();
</script>

</body>
</html>
