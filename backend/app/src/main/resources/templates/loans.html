<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>My Loans</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            width: 100%;
            padding: 20px 40px;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        header h1 {
            margin: 0;
            font-size: 22px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            font-weight: bold;
            border: 1px solid white;
            padding: 6px 12px;
            border-radius: 5px;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .logout-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            background: #e74c3c;
            color: white;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        main {
            flex: 1;
            width: 100%;
            max-width: 900px;
            margin-top: 30px;
        }

        h2 {
            margin-top: 0;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            padding: 20px 24px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
            font-size: 14px;
        }

        th {
            background: #ecf0f1;
            font-weight: 600;
        }

        tbody tr:hover {
            background: #f8f9f9;
        }

        .status-active {
            color: #e67e22;
            font-weight: 600;
        }

        .status-returned {
            color: #27ae60;
            font-weight: 600;
        }

        .message {
            margin-top: 10px;
            font-size: 13px;
        }

        .message.error {
            color: #e74c3c;
        }

        .message.info {
            color: #7f8c8d;
        }

        .btn-renew {
            background: #3498db;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-renew:hover {
            background: #2980b9;
        }

        .btn-renew[disabled] {
            opacity: 0.5;
            cursor: default;
        }

        .btn-cancel-hold {
            background: #e67e22;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel-hold:hover {
            background: #d35400;
        }

        .btn-cancel-hold[disabled] {
            opacity: 0.5;
            cursor: default;
        }
    </style>
</head>
<body>

<header>
    <h1>My Loans</h1>
    <div class="header-right">
        <a href="/dashboard" class="back-btn">‚Üê Back to Dashboard</a>
        <a href="/fines" class="back-btn">View Fines</a>
        <button class="logout-btn" id="logoutButton">Logout</button>
    </div>
</header>

<main>
    <!-- My loans (members only) -->
    <div class="card" id="myLoansCard">
        <h2>My Loans</h2>
        <p class="message info" id="myLoansMessage">Loading your loans...</p>
        <table>
            <thead>
            <tr>
                <th>Loan ID</th>
                <th>Copy ID</th>
                <th>Checkout Date</th>
                <th>Due Date</th>
                <th>Return Date</th>
                <th>Renew Count</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="myLoansTableBody"></tbody>
        </table>
    </div>

    <!-- All loans (staff only) -->
    <div class="card" id="allLoansCard" style="display:none;">
        <h2>All Loans (Staff)</h2>
        
        <!-- Filter Form -->
        <form id="allLoansFilterForm" style="margin-bottom: 20px; padding: 15px; background: #f8f9f9; border-radius: 5px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                <div>
                    <label for="filterLoanId" style="font-size: 12px; font-weight: 600;">Loan ID</label>
                    <input type="number" id="filterLoanId" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="filterUserId" style="font-size: 12px; font-weight: 600;">User ID</label>
                    <input type="number" id="filterUserId" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="filterCopyId" style="font-size: 12px; font-weight: 600;">Copy ID</label>
                    <input type="number" id="filterCopyId" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="filterRenewCount" style="font-size: 12px; font-weight: 600;">Renew Count</label>
                    <input type="number" id="filterRenewCount" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                <div>
                    <label for="filterCheckoutFrom" style="font-size: 12px; font-weight: 600;">Checkout From</label>
                    <input type="date" id="filterCheckoutFrom" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="filterCheckoutTo" style="font-size: 12px; font-weight: 600;">Checkout To</label>
                    <input type="date" id="filterCheckoutTo" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="filterDueFrom" style="font-size: 12px; font-weight: 600;">Due From</label>
                    <input type="date" id="filterDueFrom" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="filterDueTo" style="font-size: 12px; font-weight: 600;">Due To</label>
                    <input type="date" id="filterDueTo" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                <div>
                    <label for="filterReturnFrom" style="font-size: 12px; font-weight: 600;">Return From</label>
                    <input type="date" id="filterReturnFrom" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="filterReturnTo" style="font-size: 12px; font-weight: 600;">Return To</label>
                    <input type="date" id="filterReturnTo" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="filterActiveOnly" style="font-size: 12px; font-weight: 600; display: flex; align-items: center; margin-top: 20px;">
                        <input type="checkbox" id="filterActiveOnly" style="margin-right: 6px;">
                        Active Loans Only
                    </label>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn-renew" style="padding: 8px 16px;">Apply Filters</button>
                <button type="button" id="clearFiltersBtn" class="btn-cancel-hold" style="padding: 8px 16px; background: #95a5a6;">Clear Filters</button>
            </div>
        </form>
        
        <p class="message info" id="allLoansMessage">Loading all loans...</p>
        <table>
            <thead>
            <tr>
                <th>Loan ID</th>
                <th>User ID</th>
                <th>Copy ID</th>
                <th>Checkout Date</th>
                <th>Due Date</th>
                <th>Return Date</th>
                <th>Renew Count</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="allLoansTableBody"></tbody>
        </table>
    </div>

    <!-- My Holds (members only) -->
    <div class="card" id="myHoldsCard">
        <h2>My Holds</h2>
        <p class="message info" id="myHoldsMessage">Loading your holds...</p>
        <table>
            <thead>
            <tr>
                <th>Hold ID</th>
                <th>Title ID</th>
                <th>Status</th>
                <th>Placed Date</th>
                <th>Pickup Deadline</th>
                <th>Position</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="myHoldsTableBody"></tbody>
        </table>
    </div>
</main>

<script th:inline="javascript">
    let CURRENT_USER_ID = null;
    let CURRENT_USER_ROLE = null;

    document.addEventListener("DOMContentLoaded", () => {
        initLoansPage();
    });

    async function initLoansPage() {
        try {
            // Get current user info
            const res = await fetch("/api/users/me");
            if (!res.ok) {
                window.location.href = "/";
                return;
            }

            const user = await res.json();
            CURRENT_USER_ID = user.userID;
            CURRENT_USER_ROLE = user.role; // "STAFF" or "MEMBER"

            // Attach logout handler
            const logoutBtn = document.getElementById("logoutButton");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", async () => {
                    try {
                        await fetch("/api/auth/logout", { method: "POST" });
                    } catch (e) {}
                    window.location.href = "/";
                });
            }

            // Staff vs Member view
            if (CURRENT_USER_ROLE === "STAFF") {
                // Hide My Loans and My Holds for staff
                document.getElementById("myLoansCard").style.display = "none";
                document.getElementById("myHoldsCard").style.display = "none";
                
                // Show and load all loans
                const card = document.getElementById("allLoansCard");
                card.style.display = "block";
                await loadAllLoansForStaff();
            } else {
                // Members: load their loans and holds
                await loadMyLoans();
                await loadMyHolds();
            }

        } catch (err) {
            console.error("Error initializing loans page:", err);
            window.location.href = "/";
        }
    }

    async function loadMyLoans() {
        const messageEl = document.getElementById("myLoansMessage");
        const tbody = document.getElementById("myLoansTableBody");
        messageEl.textContent = "Loading your loans...";
        messageEl.className = "message info";
        tbody.innerHTML = "";

        if (!CURRENT_USER_ID) {
            messageEl.textContent = "Could not determine current user.";
            messageEl.classList.add("error");
            return;
        }

        try {
            const resp = await fetch(`/api/loans/user/${CURRENT_USER_ID}`);
            if (!resp.ok) {
                messageEl.textContent = `Error loading loans (HTTP ${resp.status}).`;
                messageEl.classList.add("error");
                return;
            }

            const loans = await resp.json();
            if (!loans || loans.length === 0) {
                messageEl.textContent = "You have no loan history.";
                messageEl.classList.remove("error");
                messageEl.classList.add("info");
                tbody.innerHTML = "";
                return;
            }

            messageEl.textContent = "";
            tbody.innerHTML = "";

            for (const loan of loans) {
                const tr = document.createElement("tr");

                const checkoutDate = formatDateTime(loan.checkoutDate);
                const dueDate = formatDateTime(loan.dueDate);
                const returnDate = loan.returnDate ? formatDateTime(loan.returnDate) : "";
                const isReturned = !!loan.returnDate;

                const statusText = isReturned ? "Returned" : "Checked Out";
                const statusClass = isReturned ? "status-returned" : "status-active";

                const canRenew = !isReturned;
                const renewButtonHtml = canRenew
                    ? `<button class="btn-renew" data-loan-id="${loan.loanID}">Renew</button>`
                    : "";

                tr.innerHTML = `
                    <td>${loan.loanID}</td>
                    <td>${loan.copyID}</td>
                    <td>${checkoutDate}</td>
                    <td>${dueDate}</td>
                    <td>${returnDate}</td>
                    <td>${loan.renewCount}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${renewButtonHtml}</td>
                `;

                tbody.appendChild(tr);
            }
        } catch (err) {
            console.error(err);
            messageEl.textContent = "Unexpected error while loading loans.";
            messageEl.classList.add("error");
        }
    }

    // Renew button handler (delegated)
    document.getElementById("myLoansTableBody").addEventListener("click", async (e) => {
        const btn = e.target;
        if (!btn.classList.contains("btn-renew")) return;

        const loanId = btn.getAttribute("data-loan-id");
        if (!loanId) return;

        const messageEl = document.getElementById("myLoansMessage");
        messageEl.textContent = "";
        messageEl.className = "message info";

        try {
            const resp = await fetch(`/api/loans/renew/${loanId}`, {
                method: "POST"
            });

            if (!resp.ok) {
                messageEl.textContent = `Reached a maximum number of renewals for this loan or cannot renew (HTTP ${resp.status}).`;
                messageEl.classList.add("error");
                return;
            }

            messageEl.textContent = "Loan renewed successfully.";
            messageEl.classList.remove("error");
            messageEl.classList.add("info");

            await loadMyLoans();
        } catch (err) {
            console.error(err);
            messageEl.textContent = "Unexpected error while renewing loan.";
            messageEl.classList.add("error");
        }
    });

    // Staff-only: load ALL loans via GET /api/loans
    async function loadAllLoansForStaff(applyFilters = false) {
        const card = document.getElementById("allLoansCard");
        const messageEl = document.getElementById("allLoansMessage");
        const tbody = document.getElementById("allLoansTableBody");

        if (!card) return;

        messageEl.textContent = "Loading all loans...";
        messageEl.className = "message info";
        tbody.innerHTML = "";

        try {
            const resp = await fetch(`/api/loans`);
            if (!resp.ok) {
                messageEl.textContent = `Error loading all loans (HTTP ${resp.status}).`;
                messageEl.classList.add("error");
                return;
            }

            let loans = await resp.json();
            if (!loans || loans.length === 0) {
                messageEl.textContent = "There are no loans in the system.";
                messageEl.classList.remove("error");
                messageEl.classList.add("info");
                return;
            }

            // Apply client-side filters if requested
            if (applyFilters) {
                loans = applyLoanFilters(loans);
            }

            if (loans.length === 0) {
                messageEl.textContent = "No loans match the filter criteria.";
                messageEl.classList.remove("error");
                messageEl.classList.add("info");
                tbody.innerHTML = "";
                return;
            }

            messageEl.textContent = `Showing ${loans.length} loan(s)`;
            tbody.innerHTML = "";

            for (const loan of loans) {
                const tr = document.createElement("tr");

                const checkoutDate = formatDateTime(loan.checkoutDate);
                const dueDate = formatDateTime(loan.dueDate);
                const returnDate = loan.returnDate ? formatDateTime(loan.returnDate) : "";
                
                // Check if loan is active (not returned) - explicitly check for null/undefined/empty
                const isActive = (loan.returnDate === null || loan.returnDate === undefined || loan.returnDate === "");

                // Staff can renew any active loan (even if max renewals reached)
                const renewButtonHtml = isActive
                    ? `<button class="btn-renew" data-loan-id="${loan.loanID}" data-staff-renew="true">Renew</button>`
                    : "";

                tr.innerHTML = `
                    <td>${loan.loanID}</td>
                    <td>${loan.userID}</td>
                    <td>${loan.copyID}</td>
                    <td>${checkoutDate}</td>
                    <td>${dueDate}</td>
                    <td>${returnDate}</td>
                    <td>${loan.renewCount}</td>
                    <td>${renewButtonHtml}</td>
                `;

                tbody.appendChild(tr);
            }
        } catch (err) {
            console.error("Unexpected error while loading all loans:", err);
            messageEl.textContent = "Unexpected error while loading all loans.";
            messageEl.classList.add("error");
        }
    }

    function applyLoanFilters(loans) {
        const filterLoanId = document.getElementById("filterLoanId").value;
        const filterUserId = document.getElementById("filterUserId").value;
        const filterCopyId = document.getElementById("filterCopyId").value;
        const filterRenewCount = document.getElementById("filterRenewCount").value;
        const filterCheckoutFrom = document.getElementById("filterCheckoutFrom").value;
        const filterCheckoutTo = document.getElementById("filterCheckoutTo").value;
        const filterDueFrom = document.getElementById("filterDueFrom").value;
        const filterDueTo = document.getElementById("filterDueTo").value;
        const filterReturnFrom = document.getElementById("filterReturnFrom").value;
        const filterReturnTo = document.getElementById("filterReturnTo").value;
        const filterActiveOnly = document.getElementById("filterActiveOnly").checked;

        return loans.filter(loan => {
            // Filter by Loan ID
            if (filterLoanId && loan.loanID !== parseInt(filterLoanId)) return false;
            
            // Filter by User ID
            if (filterUserId && loan.userID !== parseInt(filterUserId)) return false;
            
            // Filter by Copy ID
            if (filterCopyId && loan.copyID !== parseInt(filterCopyId)) return false;
            
            // Filter by Renew Count
            if (filterRenewCount && loan.renewCount !== parseInt(filterRenewCount)) return false;
            
            // Filter by Checkout Date Range
            if (filterCheckoutFrom || filterCheckoutTo) {
                const checkoutDate = new Date(loan.checkoutDate);
                if (filterCheckoutFrom && checkoutDate < new Date(filterCheckoutFrom)) return false;
                if (filterCheckoutTo && checkoutDate > new Date(filterCheckoutTo + 'T23:59:59')) return false;
            }
            
            // Filter by Due Date Range
            if (filterDueFrom || filterDueTo) {
                const dueDate = new Date(loan.dueDate);
                if (filterDueFrom && dueDate < new Date(filterDueFrom)) return false;
                if (filterDueTo && dueDate > new Date(filterDueTo + 'T23:59:59')) return false;
            }
            
            // Filter by Return Date Range
            if (filterReturnFrom || filterReturnTo) {
                if (!loan.returnDate) return false; // No return date, skip this loan
                const returnDate = new Date(loan.returnDate);
                if (filterReturnFrom && returnDate < new Date(filterReturnFrom)) return false;
                if (filterReturnTo && returnDate > new Date(filterReturnTo + 'T23:59:59')) return false;
            }
            
            // Filter by Active Only (no return date)
            if (filterActiveOnly && loan.returnDate) return false;
            
            return true;
        });
    }

    // Filter form submit handler
    document.getElementById("allLoansFilterForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        await loadAllLoansForStaff(true);
    });

    // Clear filters button handler
    document.getElementById("clearFiltersBtn")?.addEventListener("click", async () => {
        document.getElementById("allLoansFilterForm").reset();
        await loadAllLoansForStaff(false);
    });

    // Staff renew button handler (delegated) for All Loans table
    document.getElementById("allLoansTableBody").addEventListener("click", async (e) => {
        const btn = e.target;
        if (!btn.classList.contains("btn-renew")) return;

        const loanId = btn.getAttribute("data-loan-id");
        const isStaffRenew = btn.getAttribute("data-staff-renew") === "true";
        
        if (!loanId) return;

        const messageEl = document.getElementById("allLoansMessage");
        messageEl.textContent = "";
        messageEl.className = "message info";

        try {
            const resp = await fetch(`/api/loans/renew/${loanId}`, {
                method: "POST"
            });

            if (!resp.ok) {
                const errorText = await resp.text();
                messageEl.textContent = `Failed to renew loan ${loanId}: ${errorText || 'HTTP ' + resp.status}`;
                messageEl.classList.add("error");
                return;
            }

            messageEl.textContent = `Loan ${loanId} renewed successfully.`;
            messageEl.classList.remove("error");
            messageEl.classList.add("info");

            // Reload with current filter state
            const hasFilters = document.getElementById("filterLoanId").value || 
                             document.getElementById("filterUserId").value ||
                             document.getElementById("filterActiveOnly").checked;
            await loadAllLoansForStaff(hasFilters);
        } catch (err) {
            console.error(err);
            messageEl.textContent = "Unexpected error while renewing loan.";
            messageEl.classList.add("error");
        }
    });

    // ====== HOLDS (member-style view) ======

    async function loadMyHolds() {
        const messageEl = document.getElementById("myHoldsMessage");
        const tbody = document.getElementById("myHoldsTableBody");
        messageEl.textContent = "Loading your holds...";
        messageEl.className = "message info";
        tbody.innerHTML = "";

        if (!CURRENT_USER_ID) {
            messageEl.textContent = "Could not determine current user.";
            messageEl.classList.add("error");
            return;
        }

        try {
            const resp = await fetch(`/api/holds/user/${CURRENT_USER_ID}`);
            if (!resp.ok) {
                messageEl.textContent = `Error loading holds (HTTP ${resp.status}).`;
                messageEl.classList.add("error");
                return;
            }

            const holds = await resp.json();
            if (!holds || holds.length === 0) {
                messageEl.textContent = "You currently have no holds.";
                messageEl.classList.remove("error");
                messageEl.classList.add("info");
                tbody.innerHTML = "";
                return;
            }

            messageEl.textContent = "";
            tbody.innerHTML = "";

            for (const hold of holds) {
                const tr = document.createElement("tr");

                const holdId  = hold.holdID  ?? hold.holdId  ?? "";
                const titleId = hold.titleID ?? hold.titleId ?? "";
                const status  = hold.status  ?? "";
                const position = hold.position ?? hold.queuePosition ?? ""; // üëà ADD THIS

                const placed = formatDateTime(
                    hold.placedAt   || hold.placedat   || hold.placedDate ||
                    hold.createdAt  || hold.holdDate
                );

                const pickupBy = formatDateTime(
                    hold.pickupExpire    || hold.pickupexpire ||
                    hold.pickupDeadline  || hold.expirationDate ||
                    hold.expiryDate
                );

                const cancelButtonHtml = `
                    <button class="btn-cancel-hold" data-hold-id="${holdId}">
                        Cancel
                    </button>`;

                tr.innerHTML = `
                    <td>${holdId}</td>
                    <td>${titleId}</td>
                    <td>${status}</td>
                    <td>${placed}</td>
                    <td>${pickupBy}</td>
                    <td>${position}</td>          <!-- üëà NEW POSITION CELL -->
                    <td>${cancelButtonHtml}</td>  <!-- üëà ACTIONS CELL -->
                `;

                tbody.appendChild(tr);
            }

        } catch (err) {
            console.error(err);
            messageEl.textContent = "Unexpected error while loading holds.";
            messageEl.classList.add("error");
        }
    }


    // Cancel hold (member/staff cancels their own)
    document.getElementById("myHoldsTableBody").addEventListener("click", async (e) => {
        const btn = e.target;
        if (!btn.classList.contains("btn-cancel-hold")) return;

        const holdId = btn.getAttribute("data-hold-id");
        if (!holdId) return;

        if (!confirm("Are you sure you want to cancel this hold?")) {
            return;
        }

        const messageEl = document.getElementById("myHoldsMessage");
        messageEl.textContent = "";
        messageEl.className = "message info";

        try {
            const resp = await fetch(`/api/holds/${holdId}`, {
                method: "DELETE"
            });

            if (resp.status === 204) {
                messageEl.textContent = "Hold canceled successfully.";
                messageEl.classList.remove("error");
                messageEl.classList.add("info");
                await loadMyHolds();
            } else {
                messageEl.textContent = `Failed to cancel hold (HTTP ${resp.status}).`;
                messageEl.classList.add("error");
            }
        } catch (err) {
            console.error(err);
            messageEl.textContent = "Unexpected error while canceling hold.";
            messageEl.classList.add("error");
        }
    });

    // ===== UTIL =====

    function formatDateTime(value) {
        if (!value) return "";
        try {
            const d = new Date(value);
            if (isNaN(d.getTime())) return value;
            return d.toLocaleString();
        } catch (e) {
            return value;
        }
    }
</script>

</body>
</html>
