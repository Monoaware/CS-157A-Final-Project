<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edit Title - Library Management System</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            padding: 20px 40px;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        header h1 {
            margin: 0;
            font-size: 22px;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-link {
            color: white;
            text-decoration: none;
            font-weight: bold;
            border: 1px solid white;
            padding: 6px 12px;
            border-radius: 5px;
        }

        .btn-link:hover {
            background: rgba(255,255,255,0.2);
        }

        .logout-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #e74c3c;
            color: white;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        main {
            flex: 1;
            width: 100%;
            max-width: 900px;
            margin-top: 30px;
        }

        h2 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .card {
            background: white;
            padding: 20px 24px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 11px;
            margin-bottom: 12px;
        }

        .form-row > div {
            flex: 1;
            min-width: 10px;
        }

        label {
            font-weight: 600;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 8px 10px;
            margin-top: 4px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #bdc3c7;
            color: #2c3e50;
            border: none;
            padding: 8px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
        }

        .btn-secondary:hover {
            background: #a7b0b5;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .status-message {
            margin-top: 10px;
            font-size: 13px;
        }

        .status-message.error {
            color: #e74c3c;
        }

        .status-message.success {
            color: #27ae60;
        }

        .status-message.info {
            color: #7f8c8d;
        }

        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .copy-actions {
            margin-top: 20px;
            border-top: 1px solid #ecf0f1;
            padding-top: 12px;
        }
    </style>
</head>
<body>

<header>
    <h1>Edit Title</h1>
    <div class="header-right">
        <a href="/titles" class="btn-link">← Back to Catalog</a>
        <button id="logoutButton" class="logout-btn">Logout</button>
    </div>
</header>

<main>
    <div class="card">
        <h2 th:text="${title != null} ? ${title.title} : 'Edit Title'"></h2>

        <!-- Status messages -->
        <p th:if="${error}" th:text="${error}" class="status-message error"></p>
        <p th:if="${success}" th:text="${success}" class="status-message success"></p>

        <!-- Edit form -->
        <form th:if="${title != null}"
              th:action="@{/titles/{id}/edit(id=${title.titleID})}"
              method="post">

            <div class="form-row">
                <div>
                    <label for="isbn">ISBN</label>
                    <input id="isbn" name="isbn" type="text"
                           th:value="${title.ISBN}" required>
                </div>

                <div>
                    <label for="yearPublished">Year Published</label>
                    <input id="yearPublished" name="yearPublished" type="number" min="1000" max="2100"
                           th:value="${title.yearPublished}" required>
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label for="titleField">Title</label>
                    <input id="titleField" name="title" type="text"
                           th:value="${title.title}" required>
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label for="author">Author</label>
                    <input id="author" name="author" type="text"
                           th:value="${title.author}" required>
                </div>

                <div>
                    <label for="genre">Genre</label>
                    <select id="genre" name="genre" required>
                        <option th:each="g : ${genres}"
                                th:value="${g.name()}"
                                th:text="${g.name()}"
                                th:selected="${g == title.genre}">
                        </option>
                    </select>
                </div>
            </div>

            <div class="form-row" style="flex-direction: column; align-items: flex-start;">
                <label for="visible" style="font-weight: 600;">
                    Visibility
                    <input id="visible" name="visible" type="checkbox" th:checked="${title.visible}">
                </label>
            </div>

            <div class="actions-row">
                <div>
                    <button type="submit" class="btn-primary">Save Changes</button>
                    <a th:href="@{/titles/{id}(id=${title.titleID})}" class="btn-secondary">Cancel</a>
                </div>
            </div>
        </form>

        <!-- Copy management (Add Copy button) -->
        <div th:if="${title != null}" class="copy-actions">
            <button id="addCopyButton"
                    type="button"
                    class="btn-primary"
                    th:attr="data-title-id=${title.titleID}">
                Add Copy
            </button>
            <p id="copyMessage" class="status-message info"></p>
        </div>

        <!-- Separate delete form (NOT nested) -->
        <form th:if="${title != null}"
              th:action="@{/titles/{id}/delete(id=${title.titleID})}"
              method="POST"
              style="margin-top: 15px;"
              onsubmit="return confirm('Are you sure you want to delete this title? This cannot be undone.');">
            <button type="submit" class="btn-danger">Delete Title</button>
        </form>

        <p th:if="${title == null}" class="status-message error">
            Title not found.
        </p>
    </div>
</main>

<script>
    // Logout
    const logoutButton = document.getElementById("logoutButton");
    if (logoutButton) {
        logoutButton.addEventListener("click", async () => {
            try {
                await fetch("/api/auth/logout", { method: "POST" });
            } catch (e) {}
            window.location.href = "/";
        });
    }

    // Add Copy button logic (calls /api/copies)
    const addCopyButton = document.getElementById("addCopyButton");
    if (addCopyButton) {
        addCopyButton.addEventListener("click", async () => {
            const titleId = addCopyButton.getAttribute("data-title-id");
            const msg = document.getElementById("copyMessage");
            msg.textContent = "";
            msg.className = "status-message info";

            if (!titleId) {
                msg.textContent = "Unable to determine title ID.";
                msg.className = "status-message error";
                return;
            }

            try {
                // Minimal payload – adjust fields to match your Copy model if needed
                const newCopyPayload = {
                    titleID: Number(titleId),
                    barcode: "AUTO-" + Date.now(),
                    location: "MAIN",
                    status: "AVAILABLE",
                    // visible: true
                };

                const res = await fetch("/api/copies", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(newCopyPayload)
                });

                if (!res.ok) {
                    msg.textContent = `Failed to add copy (HTTP ${res.status}).`;
                    msg.className = "status-message error";
                    console.error("Add copy failed:", res.status, res.statusText);
                    return;
                }

                const created = await res.json();
                const copyId = created.copyID ?? created.copyId ?? "new";
                msg.textContent = `Copy added successfully (Copy ID: ${copyId}).`;
                msg.className = "status-message success";
            } catch (err) {
                console.error("Error while adding copy:", err);
                const msg = document.getElementById("copyMessage");
                msg.textContent = "Unexpected error while adding copy.";
                msg.className = "status-message error";
            }
        });
    }
</script>

</body>
</html>
